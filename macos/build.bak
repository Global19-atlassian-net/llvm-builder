#!/usr/bin/env bash
set -ex

cd "$(dirname "$0")"

rm -rf out
mkdir -p out
cd out

wget "https://github.com/ninja-build/ninja/releases/download/v1.8.2/ninja-linux.zip"
echo "d2fea9ff33b3ef353161ed906f260d565ca55b8ca0568fa07b1d2cab90a84a07 ninja-linux.zip" | sha256sum -c
sudo unzip ninja-linux.zip -d /usr/local/bin

# - gpg --no-tty --keyserver hkp://pgp.mit.edu --recv 0x2D2CEF1034921684
wget "https://cmake.org/files/v3.7/cmake-3.7.2-SHA-256.txt.asc"
wget "https://cmake.org/files/v3.7/cmake-3.7.2-SHA-256.txt"
# - gpg --verify cmake-3.7.2-SHA-256.txt.asc cmake-3.7.2-SHA-256.txt
wget "https://cmake.org/files/v3.7/cmake-3.7.2-Linux-x86_64.tar.gz"
( grep "cmake-3.7.2-Linux-x86_64.tar.gz" cmake-3.7.2-SHA-256.txt | sha256sum -c - )
sudo tar xzf cmake-3.7.2-Linux-x86_64.tar.gz -C /usr/local --strip-components=1

git clone https://github.com/solana-labs/llvm.git
git clone https://github.com/solana-labs/clang.git llvm/tools/clang
git clone https://github.com/solana-labs/clang-tools-extra.git llvm/tools/clang/tools/extra
git clone https://github.com/solana-labs/compiler-rt.git llvm/projects/compiler-rt
git clone https://github.com/solana-labs/lld.git llvm/tools/lld  && \

mkdir -p llvm/build
cd llvm/build
# CXX=clang++ CC=clang cmake -DCMAKE_BUILD_TYPE="MinSizeRel" -DLLVM_TARGETS_TO_BUILD=bpf -DLLVM_BUILD_LLVM_DYLIB=ON -DLLVM_USE_LINKER=gold -DCMAKE_INSTALL_PREFIX=$HOME/local -G "Ninja" ..
cmake -DCMAKE_BUILD_TYPE=Debug -DLLVM_BUILD_LLVM_DYLIB=ON -DLLVM_ENABLE_LIBCXX=ON -DLLVM_USE_LINKER=gold -DCMAKE_INSTALL_PREFIX=$HOME/local -G "Ninja" ..
ninja -j6

rm -rf deploy
mkdir -p deploy
cp -r llvm/build/bin/clang deploy
cp -r llvm/build/bin/clang++ deploy
cp -r llvm/build/bin/lld deploy
cp -r llvm/build/bin/llvm-objdump deploy
tar zcf solana-llvm-macos.tgz deploy/
